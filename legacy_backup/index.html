<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gry Przeglądarkowe</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            /* Desktop wallpaper image, cover entire screen */
            background: url('wallpapers/forest.jpg') no-repeat center center fixed;
            background-size: cover;
            height: 100vh; overflow: hidden; position: relative;
        }
        .desktop {
            height: calc(100vh - 48px); position: relative; padding: 20px;
            display: grid; grid-template-columns: repeat(auto-fit, 80px);
            grid-template-rows: repeat(auto-fit, 100px); gap: 20px;
            align-content: start; justify-content: start;
        }
        .desktop-icon {
            width: 64px; height: 64px; background: rgba(255,255,255,0.1);
            border-radius: 8px; display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all .2s ease; backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1); position: relative; text-decoration: none;
        }
        .desktop-icon:hover { background: rgba(255,255,255,0.2); transform: scale(1.05); }
        .desktop-icon::before { content: attr(data-icon); font-size: 32px; color: #fff; }
        .icon-label {
            position: absolute; top: 70px; left: 50%; transform: translateX(-50%);
            color: #fff; font-size: 11px; text-align: center; white-space: nowrap;
            text-shadow: 0 1px 2px rgba(0,0,0,.5); max-width: 80px; overflow: hidden; text-overflow: ellipsis;
        }
        .taskbar {
            position: fixed; bottom: 0; left: 0; right: 0; height: 48px;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(40px);
            display: flex; align-items: center; justify-content: center;
            border-top: 1px solid rgba(255,255,255,0.1);
            z-index: 2000; /* ensure above windows */
        }
        .start-button {
            width: 48px; height: 48px; background: transparent; border: none; cursor: pointer;
            display: flex; align-items: center; justify-content: center; font-size: 20px; color: #fff;
            transition: background .2s ease; position: absolute; left: 8px;
        }
        .start-button:hover { background: rgba(255,255,255,0.1); }
        .taskbar-apps { display: flex; align-items: center; gap: 4px; margin-left: 64px; }
        .taskbar-app {
            width: 40px; height: 40px; background: rgba(255,255,255,0.1); border-radius: 4px;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            transition: all .2s ease; position: relative; color: #fff; font-size: 18px;
        }
        .taskbar-app.active { background: rgba(255,255,255,0.2); }
        .taskbar-app.active::after {
            content: ''; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%);
            width: 20px; height: 2px; background: #0078d4; border-radius: 1px;
        }
        .taskbar-app:hover { background: rgba(255,255,255,0.15); }
        .system-tray { position: absolute; right: 8px; display: flex; align-items: center; gap: 8px; color: #fff; font-size: 13px; }

        /* Window system */
        .window {
            position: absolute;
            /* Make window container translucent so header can blur the wallpaper behind it */
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.25);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            overflow: hidden;
            resize: both;
            /* Set a safe minimum so whole games fit inside without clipping controls/boards */
            min-width: 520px;   /* accommodates wider UIs like tictactoe/connect4 controls */
            min-height: 640px;  /* accounts for header + game content + margins */
            z-index: 1500;
            animation: fadeIn .3s ease-out;
            /* Optional slight glass effect for the whole window shell */
            -webkit-backdrop-filter: blur(6px) saturate(120%);
            backdrop-filter: blur(6px) saturate(120%);
        }
        /* Glassmorphism window titlebar */
        .window-header {
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 10px;
            user-select: none;
            /* Only start drag from empty header area, not from controls */
            cursor: default;
            touch-action: none; /* allow custom touch dragging without browser gestures */
            position: relative;
            z-index: 1;
            /* Glass look */
            background: rgba(255, 255, 255, 0.12);
            background-image: linear-gradient(135deg, rgba(255,255,255,0.25), rgba(255,255,255,0.05));
            -webkit-backdrop-filter: blur(12px) saturate(140%);
            backdrop-filter: blur(12px) saturate(140%);
            border-bottom: 1px solid rgba(255,255,255,0.25);
            box-shadow:
                0 8px 24px rgba(0, 0, 0, 0.18),
                inset 0 1px 0 rgba(255, 255, 255, 0.25);
            color: #fff;
        }
        /* Fallback when backdrop-filter is not supported */
        @supports not ((-webkit-backdrop-filter: none) or (backdrop-filter: none)) {
            .window-header {
                background: rgba(20, 20, 20, 0.65);
                color: #fff;
            }
        }
        .window-title {
            font-size: 14px;
            font-weight: 600;
            letter-spacing: .2px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.35);
            color: #fff;
        }
        .window-controls {
            display: flex;
            gap: 6px;
            align-items: center;
        }
        .window-control {
            width: 28px;
            height: 28px;
            border: 1px solid rgba(255,255,255,0.25);
            border-radius: 8px;
            background: rgba(255,255,255,0.12);
            color: #fff;
            cursor: pointer;
            line-height: 1;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            touch-action: manipulation;
            transition: transform .12s ease, background .12s ease;
        }
        .window-control:hover {
            background: rgba(255,255,255,0.22);
            transform: translateY(-1px);
        }
        .window-control.close:hover {
            background: #e81123;
            border-color: rgba(255,255,255,0.35);
            color: #fff;
        }
        /* Content is opaque so games don't show through; header remains glassy over wallpaper */
        .window-content {
            height: calc(100% - 36px);
            padding: 0;
            overflow: hidden;
            background: #ffffff;
        }
        .window iframe { border: 0; width: 100%; height: 100%; display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(.98); } to { opacity: 1; transform: scale(1); } }
        .hidden { display: none; }

        /* Mobile: make opened game window fill screen area above taskbar */
        @media (max-width: 768px) {
            .desktop {
                padding: 10px;
                grid-template-columns: repeat(auto-fit, 72px);
                grid-template-rows: repeat(auto-fit, 92px);
                gap: 12px;
            }
            .window {
                left: 0 !important;
                top: 0 !important;
                width: 100vw !important;
                height: calc(100vh - 48px) !important; /* leave taskbar visible */
                border-radius: 0;
                box-shadow: none;
                resize: none;
            }
            .window-header {
                height: 40px; /* easier to grab */
            }
            .window-content {
                height: calc(100% - 40px);
            }
        }
    </style>
</head>
<body>
    <div class="desktop" id="desktop">
        <!-- Gry -->
        <div class="desktop-icon" data-icon="#️⃣" onclick="openWindow('kik','Kółko i Krzyżyk','games/tictactoe/tictactoe.html')" title="Kółko i Krzyżyk">
            <div class="icon-label">Kółko i Krzyżyk</div>
        </div>
        <div class="desktop-icon" data-icon="🧠" onclick="openWindow('memo','Memo','games/memo/memo.html')" title="Memo - gra w pary">
            <div class="icon-label">Memo</div>
        </div>
        <!-- Hidden: Gra w życie -->
        <!--
        <div class="desktop-icon" data-icon="🧬" onclick="openWindow('life','Gra w życie','games/life/life.html')" title="Gra w życie">
            <div class="icon-label">Gra w życie</div>
        </div>
        -->
        <div class="desktop-icon" data-icon="🐍" onclick="openWindow('snake','Wąż','games/snake/snake.html')" title="Wąż">
            <div class="icon-label">Wąż</div>
        </div>
        <div class="desktop-icon" data-icon="✊" onclick="openWindow('rps','Kamień Papier Nożyce','games/rps/rps.html')" title="Kamień, Papier, Nożyce">
            <div class="icon-label">Kamień Papier Nożyce</div>
        </div>
        <div class="desktop-icon" data-icon="🚩" onclick="openWindow('minesweeper','Saper','games/minesweeper/minesweeper.html')" title="Saper">
            <div class="icon-label">Saper</div>
        </div>
        <div class="desktop-icon" data-icon="🧱" onclick="openWindow('tetris','Tetris','games/tetris/tetris.html')" title="Tetris">
            <div class="icon-label">Tetris</div>
        </div>
        <div class="desktop-icon" data-icon="🟡" onclick="openWindow('connect4','Connect 4','games/connect4/connect4.html')" title="Connect 4">
            <div class="icon-label">Connect 4</div>
        </div>
        <div class="desktop-icon" data-icon="🏓" onclick="openWindow('pong','Pong','games/pong/pong.html')" title="Pong">
            <div class="icon-label">Pong</div>
        </div>
        <!-- Hidden: Gorący Ziemniak -->
        <!--
        <div class="desktop-icon" data-icon="🔥" onclick="openWindow('hotpotato','Gorący Ziemniak','games/hotpotato/hotpotato.html')" title="Gorący Ziemniak">
            <div class="icon-label">Gorący Ziemniak</div>
        </div>
        -->
        <div class="desktop-icon" data-icon="🃏" onclick="openWindow('cards','Ewolucja','games/cards/cards.html')" title="Ewolucja">
            <div class="icon-label">Ewolucja</div>
        </div>

        <!-- Inne -->
        <div class="desktop-icon" data-icon="🖩" onclick="openWindow('calc','Catculator','other/calc/calc.html')" title="Catculator">
            <div class="icon-label">Catculator</div>
        </div>

        <!-- Ustawienia -->
        <div class="desktop-icon" data-icon="⚙️" onclick="openWindow('settings','Ustawienia','settings.html')" title="Ustawienia">
            <div class="icon-label">Ustawienia</div>
        </div>
    </div>

    <div class="taskbar">
        <button class="start-button" onclick="toggleStartMenu()">⊞</button>
        <div class="taskbar-apps" id="taskbarApps"></div>
        <div class="system-tray">
            <span>🔊</span>
            <span>📶</span>
            <span id="clock">12:34</span>
        </div>
    </div>

    <script>
        // Clock
        function updateClock() {
            const now = new Date();
            const time = now.toLocaleTimeString('pl-PL', { hour: '2-digit', minute: '2-digit', hour12: false });
            const clock = document.getElementById('clock');
            if (clock) clock.textContent = time;
        }

        // Window management
        let zTop = 1500;
        let dragData = null;
        let overlay = null;

        function ensureOverlay() {
            if (overlay) return overlay;
            overlay = document.createElement('div');
            overlay.style.position = 'fixed';
            overlay.style.left = '0';
            overlay.style.top = '0';
            overlay.style.width = '100vw';
            overlay.style.height = 'calc(100vh - 48px)'; // do not cover taskbar
            overlay.style.pointerEvents = 'none';
            overlay.style.zIndex = '9999';
            overlay.style.cursor = 'grabbing';
            document.body.appendChild(overlay);
            return overlay;
        }

        function openWindow(id, title, url) {
            // Focus if exists
            const existing = document.getElementById(id + '-window');
            if (existing) {
                existing.style.display = 'block';
                existing.style.zIndex = String(++zTop);
                setTaskbarActive(id, true);
                return;
            }

            // Create window
            const win = document.createElement('div');
            win.className = 'window';
            win.id = id + '-window';
            win.style.left = (100 + Math.floor(Math.random() * 80)) + 'px';
            win.style.top = (50 + Math.floor(Math.random() * 60)) + 'px';
            // Initial window size large enough to contain full game UIs without overflow
            win.style.width = '960px';
            win.style.height = '720px';
            win.style.zIndex = String(++zTop);

            // On small screens, start maximized to fit area above taskbar
            if (window.matchMedia('(max-width: 768px)').matches) {
                win.style.left = '0';
                win.style.top = '0';
                win.style.width = '100vw';
                win.style.height = 'calc(100vh - 48px)';
                win.dataset.max = '1';
            }
            // Prevent duplicate bottom bars inside iframes by injecting CSS (same-origin only)
            const cssBlock = `
                <style>
                    .taskbar, #taskbar { display: none !important; }
                    footer.site-footer, .site-footer { display: none !important; }
                    .navbar, .bottom-bar { display: none !important; }
                </style>
            `;
            win.querySelector('iframe')?.addEventListener('load', function () {
                try {
                    const doc = this.contentDocument;
                    if (doc && doc.head) {
                        const styleWrapper = doc.createElement('div');
                        styleWrapper.innerHTML = cssBlock;
                        const styleEl = styleWrapper.firstElementChild;
                        if (styleEl) doc.head.appendChild(styleEl);
                    }
                } catch (e) {
                    // Cross-origin or blocked: ignore
                }
            });

            win.innerHTML = `
                <div class="window-header" onmousedown="startDrag(event, '${id}-window')" ontouchstart="/* handled in JS */" ondblclick="maximizeWindow('${id}-window')">
                    <div class="window-title">${title}</div>
                    <div class="window-controls">
                        <button class="window-control minimize" onclick="minimizeWindow('${id}-window')" title="Minimalizuj">−</button>
                        <button class="window-control maximize" onclick="maximizeWindow('${id}-window')" title="Maksymalizuj">□</button>
                        <button class="window-control close" onclick="closeWindow('${id}-window')" title="Zamknij">×</button>
                    </div>
                </div>
                <div class="window-content">
                    <!-- Ensure iframe can scale while keeping full content visible -->
                    <iframe src="${url}" sandbox="allow-scripts allow-same-origin allow-forms allow-popups" style="width:100%; height:100%;"></iframe>
                </div>
            `;
            // Ensure iframe doesn't steal pointer during drag (desktop)
            const header = win.querySelector('.window-header');
            const iframe = win.querySelector('iframe');
            if (header && iframe) {
                header.addEventListener('mousedown', (e) => {
                    if (!(e.target instanceof HTMLElement) || e.target.closest('.window-controls')) return;
                    iframe.style.pointerEvents = 'none';
                }, { passive: true });
                document.addEventListener('mouseup', () => {
                    iframe.style.pointerEvents = 'auto';
                }, { passive: true });

                // Mobile/touch: enable controls to work and support dragging
                header.addEventListener('touchstart', (e) => {
                    const t = e.target;
                    if (!(t instanceof HTMLElement)) return;
                    // If tap on control buttons, don't start drag; let click fire
                    if (t.closest('.window-controls') || t.classList.contains('window-control')) {
                        return;
                    }
                    iframe.style.pointerEvents = 'none';
                    const touch = e.touches[0];
                    startDragLikeTouch(touch.clientX, touch.clientY, win.id);
                    e.preventDefault();
                }, { passive: false });
                header.addEventListener('touchmove', (e) => {
                    if (!dragData) return;
                    const touch = e.touches[0];
                    dragLikeTouch(touch.clientX, touch.clientY);
                    e.preventDefault();
                }, { passive: false });
                header.addEventListener('touchend', () => {
                    stopDrag();
                    iframe.style.pointerEvents = 'auto';
                }, { passive: true });

                // Touch support for mobile
                header.addEventListener('touchstart', (e) => {
                    const t = e.target;
                    if (!(t instanceof HTMLElement) || t.closest('.window-controls')) return;
                    iframe.style.pointerEvents = 'none';
                    const touch = e.touches[0];
                    startDragLikeTouch(touch.clientX, touch.clientY, win.id);
                    e.preventDefault();
                }, { passive: false });
                header.addEventListener('touchmove', (e) => {
                    if (!dragData) return;
                    const touch = e.touches[0];
                    dragLikeTouch(touch.clientX, touch.clientY);
                    e.preventDefault();
                }, { passive: false });
                header.addEventListener('touchend', () => {
                    stopDrag();
                    iframe.style.pointerEvents = 'auto';
                }, { passive: true });
            }

            document.body.appendChild(win);
            addTaskbarItem(id, title);
        }

        function addTaskbarItem(id, title) {
            const apps = document.getElementById('taskbarApps');
            if (document.getElementById('tb-' + id)) return;
            const el = document.createElement('div');
            el.className = 'taskbar-app active';
            el.id = 'tb-' + id;
            el.title = title;
            el.textContent = '🗔';
            el.onclick = () => {
                const w = document.getElementById(id + '-window');
                if (!w) return;
                if (w.style.display === 'none') {
                    w.style.display = 'block';
                }
                w.style.zIndex = String(++zTop);
                setTaskbarActive(id, true);
            };
            apps.appendChild(el);
        }

        function setTaskbarActive(id, active) {
            const el = document.getElementById('tb-' + id);
            if (!el) return;
            if (active) el.classList.add('active'); else el.classList.remove('active');
        }

        function closeWindow(windowId) {
            const w = document.getElementById(windowId);
            if (!w) return;
            const id = windowId.replace('-window', '');
            const tb = document.getElementById('tb-' + id);
            if (tb) tb.remove();
            w.remove();
        }

        function minimizeWindow(windowId) {
            const w = document.getElementById(windowId);
            if (!w) return;
            w.style.display = 'none';
            const id = windowId.replace('-window', '');
            setTaskbarActive(id, false);
        }

        function maximizeWindow(windowId) {
            const w = document.getElementById(windowId);
            if (!w) return;
            const isMax = w.dataset.max === '1';
            if (isMax) {
                // restore
                w.style.width = w.dataset.w || '800px';
                w.style.height = w.dataset.h || '560px';
                w.style.left = w.dataset.l || '100px';
                w.style.top = w.dataset.t || '50px';
                w.dataset.max = '0';
            } else {
                // store
                const rect = w.getBoundingClientRect();
                w.dataset.w = rect.width + 'px';
                w.dataset.h = rect.height + 'px';
                w.dataset.l = rect.left + 'px';
                w.dataset.t = rect.top + 'px';
                // maximize
                w.style.left = '0';
                w.style.top = '0';
                w.style.width = '100vw';
                w.style.height = 'calc(100vh - 48px)';
                w.dataset.max = '1';
            }
            w.style.zIndex = String(++zTop);
        }

        function startDrag(event, windowId) {
            const w = document.getElementById(windowId);
            if (!w) return;
            // Don't start drag when clicking on window controls
            if (event && event.target && event.target.closest && event.target.closest('.window-controls')) {
                return;
            }
            const rect = w.getBoundingClientRect();
            dragData = {
                id: windowId,
                offsetX: event.clientX - rect.left,
                offsetY: event.clientY - rect.top
            };
            const ov = ensureOverlay();
            ov.style.pointerEvents = 'auto';
            document.addEventListener('mousemove', drag, { passive: false });
            document.addEventListener('mouseup', stopDrag, { passive: false });
            w.style.zIndex = String(++zTop);
            event.preventDefault();
        }

        // Touch helpers
        function startDragLikeTouch(clientX, clientY, windowId) {
            const w = document.getElementById(windowId);
            if (!w) return;
            const rect = w.getBoundingClientRect();
            dragData = {
                id: windowId,
                offsetX: clientX - rect.left,
                offsetY: clientY - rect.top
            };
            const ov = ensureOverlay();
            ov.style.pointerEvents = 'auto';
            w.style.zIndex = String(++zTop);
        }
        function dragLikeTouch(clientX, clientY) {
            if (!dragData) return;
            const w = document.getElementById(dragData.id);
            const parentWidth = document.body.clientWidth;
            const parentHeight = document.body.clientHeight - 48;
            let newX = clientX - dragData.offsetX;
            let newY = clientY - dragData.offsetY;
            newX = Math.max(0, Math.min(newX, parentWidth - w.offsetWidth));
            newY = Math.max(0, Math.min(newY, parentHeight - w.offsetHeight));
            w.style.left = newX + 'px';
            w.style.top = newY + 'px';
        }

        function drag(event) {
            if (!dragData) return;
            const w = document.getElementById(dragData.id);
            const parentWidth = document.body.clientWidth;
            const parentHeight = document.body.clientHeight - 48; // above taskbar
            let newX = event.clientX - dragData.offsetX;
            let newY = event.clientY - dragData.offsetY;
            newX = Math.max(0, Math.min(newX, parentWidth - w.offsetWidth));
            newY = Math.max(0, Math.min(newY, parentHeight - w.offsetHeight));
            w.style.left = newX + 'px';
            w.style.top = newY + 'px';
        }

        function stopDrag() {
            dragData = null;
            if (overlay) overlay.style.pointerEvents = 'none';
            document.removeEventListener('mousemove', drag);
            document.removeEventListener('mouseup', stopDrag);
        }

        function toggleStartMenu() { console.log('Start menu toggled'); }

        // Init
        updateClock();
        setInterval(updateClock, 1000);
    </script>
</body>
</html>
